---
layout: default
title: NM Health Code Violations
---

<div class="page-title">
  <h1 class="page-title__heading">New Mexico Restaurant Health Violations</h1>
  <p class="page-title__subtitle">
    Find restaurants with recent health code violations across NM's 10 biggest cities
  </p>
</div>

<!-- Toolbar with sort and export (shared data with violations list below) -->
<div class="toolbar" x-data="{ get violations() { return Alpine.store('violations') } }">
  <div class="toolbar__section">
    <span class="toolbar__label">Sort by:</span>
    <select x-model="$store.violations.sortBy" @change="$store.violations.sortViolations()" class="select" style="width: auto;">
      <option value="severity">Severity (High to Low)</option>
      <option value="date">Most Recent</option>
      <option value="name">Name (A-Z)</option>
    </select>
  </div>
  
  <div class="toolbar__section">
    <span class="toolbar__label" x-text="`${$store.violations.filteredViolations.length} results`"></span>
    <button @click="$store.violations.exportToCSV()" class="btn btn--small btn--secondary">
      üì• Export CSV
    </button>
    <button @click="$store.violations.exportToJSON()" class="btn btn--small btn--secondary">
      üì• Export JSON
    </button>
  </div>
</div>

<!-- Filter Panel -->
{% include filter-controls.html %}

<!-- Violations List -->
<div class="violations" x-data="violationsList()">
  <!-- Loading State -->
  <template x-if="loading">
    <div class="empty-state">
      <div class="empty-state__icon">‚è≥</div>
      <h3 class="empty-state__message">Loading violations...</h3>
    </div>
  </template>
  
  <!-- Error State -->
  <template x-if="error && !loading">
    <div class="empty-state">
      <div class="empty-state__icon">‚ö†Ô∏è</div>
      <h3 class="empty-state__message">Failed to load data</h3>
      <p class="empty-state__hint" x-text="error"></p>
      <p class="empty-state__hint">
        The data pipeline hasn't run yet. Check back once the data is populated.
      </p>
    </div>
  </template>
  
  <!-- Empty State (no results) -->
  <template x-if="!loading && !error && violations.length === 0">
    <div class="empty-state">
      <div class="empty-state__icon">üîç</div>
      <h3 class="empty-state__message">No violations found</h3>
      <p class="empty-state__hint">Try adjusting your filters</p>
    </div>
  </template>
  
  <!-- Violations Cards -->
  <template x-for="violation in violations" :key="violation.id">
    <article class="violation-card">
      <div>
        <div class="violation-card__header">
          <h3 class="violation-card__title" x-text="violation.establishment.name"></h3>
          <span 
            class="badge"
            :class="`badge--${getSeverityLevel(violation.score.severity)}`"
            x-text="getSeverityLevel(violation.score.severity).toUpperCase()">
          </span>
        </div>
        
        <div class="violation-card__meta">
          <div class="violation-card__meta-item">
            <strong>City:</strong>
            <span x-text="violation.establishment.city"></span>
          </div>
          <div class="violation-card__meta-item">
            <strong>Date:</strong>
            <span x-text="violation.inspection.date"></span>
          </div>
          <div class="violation-card__meta-item">
            <strong>Outcome:</strong>
            <span x-text="violation.inspection.outcome"></span>
          </div>
          <div class="violation-card__meta-item">
            <strong>Score:</strong>
            <span x-text="violation.score.severity"></span>
          </div>
        </div>
        
        <div class="violation-card__details">
          <p>
            <strong>Address:</strong>
            <span x-text="violation.establishment.address"></span>
          </p>
          
          <template x-if="violation.score.reasons && violation.score.reasons.length > 0">
            <div>
              <strong>Reasons:</strong>
              <ul style="margin: 8px 0 0 20px; list-style: disc;">
                <template x-for="reason in violation.score.reasons" :key="reason">
                  <li x-text="reason" style="margin-bottom: 4px; font-size: 14px;"></li>
                </template>
              </ul>
            </div>
          </template>
          
          <template x-if="violation.inspection.violations && violation.inspection.violations.length > 0">
            <div class="violation-card__violations" style="margin-top: 16px;">
              <strong>Violations:</strong>
              <ul style="margin: 8px 0 0 20px; list-style: disc;">
                <template x-for="v in violation.inspection.violations.slice(0, 3)" :key="v.code">
                  <li style="margin-bottom: 4px; font-size: 14px;">
                    <span x-text="`[${v.code}] ${v.desc}`"></span>
                    <template x-if="v.critical">
                      <strong style="color: #d32f2f;"> (CRITICAL)</strong>
                    </template>
                  </li>
                </template>
                <template x-if="violation.inspection.violations.length > 3">
                  <li style="font-size: 14px; color: #757575;">
                    <span x-text="`+${violation.inspection.violations.length - 3} more violations`"></span>
                  </li>
                </template>
              </ul>
            </div>
          </template>
        </div>
      </div>
      
      <div class="violation-card__actions">
        <template x-if="violation.links && violation.links.source">
          <a 
            :href="violation.links.source" 
            target="_blank" 
            rel="noopener"
            class="btn btn--small btn--outline">
            View Source
          </a>
        </template>
      </div>
    </article>
  </template>
</div>
